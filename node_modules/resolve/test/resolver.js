var path = require('path');
var fs = require('fs');
var test = require('tape');
var resolve = require('../');
var async = require('../async');

test('`./async` entry point', function (t) {
    t.equal(resolve, async, '`./async` entry point is the same as `main`');
    t.end();
});

test('async foo', function (t) {
    t.plan(12);
    var dir = path.join(__dirname, 'resolver');

    resolve('./foo', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.name, 'resolve');
    });

    resolve('./foo.js', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.name, 'resolve');
    });

    resolve('./foo', { basedir: dir, 'package': { main: 'resolver' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.main, 'resolver');
    });

    resolve('./foo.js', { basedir: dir, 'package': { main: 'resolver' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg.main, 'resolver');
    });

    resolve('./foo', { basedir: dir, filename: path.join(dir, 'baz.js') }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
    });

    resolve('foo', { basedir: dir }, function (err) {
        t.equal(err.message, "Cannot find module 'foo' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    });

    // Test that filename is reported as the "from" value when passed.
    resolve('foo', { basedir: dir, filename: path.join(dir, 'baz.js') }, function (err) {
        t.equal(err.message, "Cannot find module 'foo' from '" + path.join(dir, 'baz.js') + "'");
    });
});

test('bar', function (t) {
    t.plan(6);
    var dir = path.join(__dirname, 'resolver');

    resolve('foo', { basedir: dir + '/bar' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('foo', { basedir: dir + '/bar' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('foo', { basedir: dir + '/bar', 'package': { main: 'bar' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg.main, 'bar');
    });
});

test('baz', function (t) {
    t.plan(4);
    var dir = path.join(__dirname, 'resolver');

    resolve('./baz', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'baz/quux.js'));
        t.equal(pkg.main, 'quux.js');
    });

    resolve('./baz', { basedir: dir, 'package': { main: 'resolver' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'baz/quux.js'));
        t.equal(pkg.main, 'quux.js');
    });
});

test('biz', function (t) {
    t.plan(24);
    var dir = path.join(__dirname, 'resolver/biz/node_modules');

    resolve('./grux', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('./grux', { basedir: dir, 'package': { main: 'biz' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg.main, 'biz');
    });

    resolve('./garply', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('./garply', { basedir: dir, 'package': { main: 'biz' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('tiv', { basedir: dir + '/grux' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('tiv', { basedir: dir + '/grux', 'package': { main: 'grux' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg.main, 'grux');
    });

    resolve('tiv', { basedir: dir + '/garply' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('tiv', { basedir: dir + '/garply', 'package': { main: './lib' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('grux', { basedir: dir + '/tiv' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('grux', { basedir: dir + '/tiv', 'package': { main: 'tiv' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg.main, 'tiv');
    });

    resolve('garply', { basedir: dir + '/tiv' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('garply', { basedir: dir + '/tiv', 'package': { main: 'tiv' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });
});

test('quux', function (t) {
    t.plan(2);
    var dir = path.join(__dirname, 'resolver/quux');

    resolve('./foo', { basedir: dir, 'package': { main: 'quux' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo/index.js'));
        t.equal(pkg.main, 'quux');
    });
});

test('normalize', function (t) {
    t.plan(2);
    var dir = path.join(__dirname, 'resolver/biz/node_modules/grux');

    resolve('../grux', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'index.js'));
        t.equal(pkg, undefined);
    });
});

test('cup', function (t) {
    t.plan(5);
    var dir = path.join(__dirname, 'resolver');

    resolve('./cup', { basedir: dir, extensions: ['.js', '.coffee'] }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'cup.coffee'));
    });

    resolve('./cup.coffee', { basedir: dir }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'cup.coffee'));
    });

    resolve('./cup', { basedir: dir, extensions: ['.js'] }, function (err, res) {
        t.equal(err.message, "Cannot find module './cup' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    });

    // Test that filename is reported as the "from" value when passed.
    resolve('./cup', { basedir: dir, extensions: ['.js'], filename: path.join(dir, 'cupboard.js') }, function (err, res) {
        t.equal(err.message, "Cannot find module './cup' from '" + path.join(dir, 'cupboard.js') + "'");
    });
});

test('mug', function (t) {
    t.plan(3);
    var dir = path.join(__dirname, 'resolver');

    resolve('./mug', { basedir: dir }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'mug.js'));
    });

    resolve('./mug', { basedir: dir, extensions: ['.coffee', '.js'] }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, '/mug.coffee'));
    });

    resolve('./mug', { basedir: dir, extensions: ['.js', '.coffee'] }, function (err, res) {
        t.equal(res, path.join(dir, '/mug.js'));
    });
});

test('other path', function (t) {
    t.plan(6);
    var resolverDir = path.join(__dirname, 'resolver');
    var dir = path.join(resolverDir, 'bar');
    var otherDir = path.join(resolverDir, 'other_path');

    resolve('root', { basedir: dir, paths: [otherDir] }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(resolverDir, 'other_path/root.js'));
    });

    resolve('lib/other-lib', { basedir: dir, paths: [otherDir] }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(resolverDir, 'other_path/lib/other-lib.js'));
    });

    resolve('root', { basedir: dir }, function (err, res) {
        t.equal(err.message, "Cannot find module 'root' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    });

    resolve('zzz', { basedir: dir, paths: [otherDir] }, function (err, res) {
        t.equal(err.message, "Cannot find module 'zzz' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    });
});

test('path iterator', function (t) {
    t.plan(2);

    var resolverDir = path.join(__dirname, 'resolver');

    var exactIterator = function (x, start, getPackageCandidates, opts) {
        return [path.join(resolverDir, x)];
    };

    resolve('baz', { packageIterator: exactIterator }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(resolverDir, 'baz/quux.js'));
        t.equal(pkg && pkg.name, 'baz');
    });
});

test('incorrect main', function (t) {
    t.plan(1);

    var resolverDir = path.join(__dirname, 'resolver');
    var dir = path.join(resolverDir, 'incorrect_main');

    resolve('./incorrect_main', { basedir: resolverDir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'index.js'));
    });
});

test('missing index', function (t) {
    t.plan(2);

    var resolverDir = path.join(__dirname, 'resolver');
    resolve('./missing_index', { basedir: resolverDir }, function (err, res, pkg) {
        t.ok(err instanceof Error);
        t.equal(err && err.code, 'MODULE_NOT_FOUND', 'error has correct error code');
    });
});

test('missing main', function (t) {
    t.plan(1);

    var resolverDir = path.join(__dirname, 'resolver');

    resolve('./missing_main', { basedir: resolverDir }, function (err, res, pkg) {
        t.equal(err && err.code, 'MODULE_NOT_FOUND', 'error has correct error code');
    });
});

test('null main', function (t) {
    t.plan(1);

    var resolverDir = path.join(__dirname, 'resolver');

    resolve('./null_main', { basedir: resolverDir }, function (err, res, pkg) {
        t.equal(err && err.code, 'MODULE_NOT_FOUND', 'error has correct error code');
    });
});

test('main: false', function (t) {
    t.plan(2);

    var basedir = path.join(__dirname, 'resolver');
    var dir = path.join(basedir, 'false_main');
    resolve('./false_main', { basedir: basedir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(
            res,
            path.join(dir, 'index.js'),
            '`"main": false`: resolves to `index.js`'
        );
        t.deepEqual(pkg, {
            name: 'false_main',
            main: false
        });
    });
});

test('without basedir', function (t) {
    t.plan(1);

    var dir = path.join(__dirname, 'resolver/without_basedir');
    var tester = require(path.join(dir, 'main.js')); // eslint-disable-line global-require

    tester(t, function (err, res, pkg) {
        if (err) {
            t.fail(err);
        } else {
            t.equal(res, path.join(dir, 'node_modules/mymodule.js'));
        }
    });
});

test('#52 - incorrectly resolves module-paths like "./someFolder/" when there is a file of the same name', function (t) {
    t.plan(2);

    var dir = path.join(__dirname, 'resolver');

    resolve('./foo', { basedir: path.join(dir, 'same_names') }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo.js'));
    });

    resolve('./foo/', { basedir: path.join(dir, 'same_names') }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo/index.js'));
    });
});

test('#211 - incorrectly resolves module-paths like "." when from inside a folder with a sibling file of the same name', function (t) {
    t.plan(2);

    var dir = path.join(__dirname, 'resolver');

    resolve('./', { basedir: path.join(dir, 'same_names/foo') }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo/index.js'));
    });

    resolve('.', { basedir: path.join(dir, 'same_names/foo') }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo/index.js'));
    });
});

test('async: #121 - treating an existing file as a dir when no basedir', function (t) {
    var testFile = path.basename(__filename);

    t.test('sanity check', function (st) {
        st.plan(1);
        resolve('./' + testFile, function (err, res, pkg) {
            if (err) t.fail(err);
            st.equal(res, __filename, 'sanity check');
        });
    });

    t.test('with a fake directory', function (st) {
        st.plan(4);

        resolve('./' + testFile + '/blah', function (err, res, pkg) {
            st.ok(err, 'there is an error');
            st.notOk(res, 'no result');

            st.equal(err && err.code, 'MODULE_NOT_FOUND', 'error code matches require.resolve');
            st.equal(
                err && err.message,
                'Cannot find module \'./' + testFile + '/blah\' from \'' + __dirname + '\'',
                'can not find nonexistent module'
            );
            st.end();
        });
    });

    t.end();
});

test('async dot main', function (t) {
    var start = new Date();
    t.plan(3);
    resolve('./resolver/dot_main', function (err, ret) {
        t.notOk(err);
        t.equal(ret, path.join(__dirname, 'resolver/dot_main/index.js'));
        t.ok(new Date() - start < 50, 'resolve.sync timedout');
        t.end();
    });
});

test('async dot slash main', function (t) {
    var start = new Date();
    t.plan(3);
    resolve('./resolver/dot_slash_main', function (err, ret) {
        t.notOk(err);
        t.equal(ret, path.join(__dirname, 'resolver/dot_slash_main/index.js'));
        t.ok(new Date() - start < 50, 'resolve.sync timedout');
        t.end();
    });
});

test('not a directory', function (t) {
    t.plan(6);
    var path = './foo';
    resolve(path, { basedir: __filename }, function (err, res, pkg) {
        t.ok(err, 'a non-directory errors');
        t.equal(arguments.length, 1);
        t.equal(res, undefined);
        t.equal(pkg, undefined);

        t.equal(err && err.message, 'Cannot find module \'' + path + '\' from \'' + __filename + '\'');
        t.equal(err && err.code, 'MODULE_NOT_FOUND');
    });
});

test('non-string "main" field in package.json', function (t) {
    t.plan(5);

    var dir = path.join(__dirname, 'resolver');
    resolve('./invalid_main', { basedir: dir }, function (err, res, pkg) {
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package ‚Äúinvalid_main‚Äù `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
        t.equal(res, undefined, 'res is undefined');
        t.equal(pkg, undefined, 'pkg is undefined');
    });
});

test('non-string "main" field in package.json', function (t) {
    t.plan(5);

    var dir = path.join(__dirname, 'resolver');
    resolve('./invalid_main', { basedir: dir }, function (err, res, pkg) {
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package ‚Äúinvalid_main‚Äù `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
        t.equal(res, undefined, 'res is undefined');
        t.equal(pkg, undefined, 'pkg is undefined');
    });
});

test('browser field in package.json', function (t) {
    t.plan(3);

    var dir = path.join(__dirname, 'resolver');
    resolve(
        './browser_field',
        {
            basedir: dir,
            packageFilter: function packageFilter(pkg) {
                if (pkg.browser) {
                    pkg.main = pkg.browser; //Tœ)µt’|≈  i’»≤‰≤.  
   @  î∆≠Ã\’  ë«≈≈@«  ÙºH≈  ®∫‹¥–≈¡  »’©∆¥¿…  J≈µ¬»≤‰≤.  
     ,  î∆≠Ã\’  ç¡1¡D«  >Ã¿…  ª∫à’µ¬»≤‰≤.  
   @  " S e n d U s i n g "   l≠1¡  ¨t«  ò«ª∫¥»≈µ¬»≤‰≤.  
     @  " P o s t U s i n g "   l≠1¡  ¨t«  ò«ª∫¥»≈µ¬»≤‰≤.  
     P  P i c k u p   µ	∏0—¨π  Ω¨\∏ ¨  D’î∆X’¿…Ãπ  ¿…»¥¿…  J≈X≈µ¬»≤‰≤.    
     8  X’ò∞  t«¡¿X«  T∫‹¬¿…|π  ≠¿»`’  ¬  ∆≈µ¬»≤‰≤.  
   P  –∆¯º<«\∏  ¨¿©∆X’î≤  ¨¥Ã–≈¡  î∆≠Ã\’  ë«≈≈D«  ¨¿©∆`’  ¬  ∆≈µ¬»≤‰≤.  
     $  ç¡1¡t«  }«0Æ  »©∆Ö«»≤‰≤.  
   (  ç¡1¡D«  ≠¿»`’  ¬  ∆≈µ¬»≤‰≤.  
   H  ¨¥Ã–≈  0Æ]∏\’  p≥t«0— ¨  |«XŒX’¿…  J≈p¨ò∞  ò«ª∫¥»≈µ¬»≤‰≤.    
   @  î∆≠Ã\’  ç¡1¡t«  T∫|«  8∫¨π Æ  t«Ñπ  ı¨¨–≈  ∆≈µ¬»≤‰≤.  
   D  î∆≠Ã\’  8ªê«  —…i’t«  ÙŒË‘0—–≈  $¡XŒ¥¥≈  à«¿…  J≈µ¬»≤‰≤.  
   0  A D O   §¬∏“ºπD«  Ù≈¿…  J≈X≈µ¬»≤‰≤.  
     $  ËŒP—∏“  ç¡1¡t«  ∆≈µ¬»≤‰≤.  
   P  ËŒP—∏“  ç¡1¡  X M L D«  U T F - 8 D«  ¨¿©∆X’Ï≈  x«Tœ)µt’|≈  i’»≤‰≤.  
     @  ËŒP—∏“  ç¡1¡  X M L D«  l≠8ª  ÑΩ¡X’¿…  ª∫à’µ¬»≤‰≤.  
     H  ç¡1¡D«  X M L –≈¡  î∆≠Ã\’  ÷›¬<«\∏  ¿ºX÷`’  ¬  ∆≈µ¬»≤‰≤.  
     <  U÷x«–≈   ≥\’  µ	∏0—¨π|π  ¿…»X’¿…  J≈X≈µ¬»≤‰≤.  
     H  X’ò∞  t«¡¿X«  π“»  µ	∏0—¨π–≈   ≥t’  U÷x«`’  ¬  ∆≈µ¬»≤‰≤.  
     8  Ùº∏∞  ¨¿å∑X«  ¨¿¡h’D«  >ÃD«  ¬  ∆≈µ¬»≤‰≤.  
     0  ê«¥Ã  ºx«)µD«  »’©∆X’¿…  J≈µ¬»≤‰≤.  
     H  ¨¥ÃX«  8Ã¡ê«  p≥t«0— ¨  |«XŒX’¿…  J≈p¨ò∞  ò«ª∫¥»≈µ¬»≤‰≤.    
   `  –∆X’î≤  Ì≈`’   «÷D«  T≥  t«¡¿  ¨¿©∆`’  ¬  ∆≈µ¬»≤‰≤.   -   \Õ ≥¨–≈  ƒ≥Ï≤à’µ¬»≤‰≤.  
     †  ÷¨«  ë«≈≈  ÷›¬<«\∏  ¥  ë«≈≈@«  A s s i g n –≈   ≥t’  8÷úÕD«  »’©∆X’¿…  J≈µ¬»≤‰≤.    ≥‡¬  C r e a t e U n a s s i g n e d C o p y |π  8÷úÕX’Ì¬‹¬$∆.  
   <  ë«≈≈t«  ÷¨«  ¨¿©∆ê«–≈å¨  `’˘≤¥¿…  J≈X≈µ¬»≤‰≤.  
     @  a≈8¡§¬  …t«p¨ò∞  p»ë«  …x«  m’©∫t«  ÃπÃ∏¥»≈µ¬»≤‰≤.  
   ,  ´Ã  àº¯…  x«¬ ¨  ò«ª∫¥»≈µ¬»≤‰≤.  
   ,  P¥  àº¯…  x«¬ ¨  ò«ª∫¥»≈µ¬»≤‰≤.  
   ,  8¡  àº¯…  x«¬ ¨  ò«ª∫¥»≈µ¬»≤‰≤.  
   ,  $±  àº¯…  x«¬ ¨  ò«ª∫¥»≈µ¬»≤‰≤.  
   0  ‰≤/¡  àº¯…  x«¬ ¨  ò«ª∫¥»≈µ¬»≤‰≤.  
     D  î∆≠Ã\’  ¯º8ª  ÄΩÑΩD«  t«  T∫‹¬¿…–≈¡  >Ã¿…  ª∫à’µ¬»≤‰≤.  
     4  ËŒP—∏“  x«Tœ)µ  ÷›¬t«  ò«ª∫¥»≈µ¬»≤‰≤.  
     Ù  % 1   E v e n t   M e t h o d   i s   h a l t i n g ,   H R E S U L T   % 2  
 % n % n F o r   m o r e   i n f o r m a t i o n ,   c l i c k   h t t p : / / w w w . m i c r o s o f t . c o m / c o n t e n t r e d i r e c t . a s p .  
    C a l e n d a r i n g   a g e n t   f a i l e d   t o   i n i t i a l i z e   w i t h   e r r o r   % 1 .  
 % n % n F o r   m o r e   i n f o r m a t i o n ,   c l i c k   h t t p : / / w w w . m i c r o s o f t . c o m / c o n t e n t r e d i r e c t . a s p .  
     T C a l e n d a r i n g   r e c u r r i n g   i t e m   e x p a n s i o n   f a i l e d   t o   r e g i s t e r   f o r   n o t i f i c a t i o n s   f o r   M D B   % 1 .  
 % n % n F o r   m o r e   i n f o r m a t i o n ,   c l i c k   h t t p : / / w w w . m i c r o s o f t . c o m / c o n t e n t r e d i r e c t . a s p .  
     D C a l e n d a r i n g   a g e n t   f a i l e d   i n   m e s s a g e   s a v e   n o t i f i c a t i o n   w i t h   e r r o r   % 1   o n   % 2 :   % 3 .  
 % n % n F o r   m o r e   i n f o r m a t i o n ,   c l i c k   h t t p : / / w w w . m i c r o s o f t . c o m / c o n t e n t r e d i r e c t . a s p .  
   H C a l e n d a r i n g   a g e n t   f a i l e d   i n   m e s s a g e   d e l e t e   n o t i f i c a t i o n   w i t h   e r r o r   % 1   o n   % 2 :   % 3 .  
 % n % n F o r   m o r e   i n f o r m a t i o n ,   c l i c k   h t t p : / / w w w . m i c r o s o f t . c o m / c o n t e n t r e d i r e c t . a s p .  
   D C a l e n d a r i n g   a g e n t   f a i l e d   i n   f o l d e r   s a 